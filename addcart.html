<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    h4 {
      text-align: center;
      border-bottom: 2px solid rgb(201, 34, 34);
      padding: 1rem;
      margin: 1rem;
      font-size: 1.2rem;
    }

    .continue {
      /*margin-left: 200px;*/
      padding: 0.5rem;
      border-radius: 5px;
      color: white;
      background-color: darkgray;
      display: block;
      border: none;
      cursor: pointer;
      margin-top: 1.5rem;
      margin-left: auto; /* pushes it to the right */
      margin-right: 2rem;
    }

    .checkout {
      background-color: green;
      color: white;
      font-size: 1.2rem;
      padding: 10px 20px;
      margin: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button {
      font-size: 1.2rem;
    }

    table#cartTable {
      font-size: 1.2rem;
      margin-top: 2rem;
      border: 0.5px solid rgb(145, 137, 137);
    }

    #cartTable th,
    #cartTable td {
      padding: 10px;
      font-size: 1.2rem;
    }

    #thankyoumessage {
      font-size: 2rem;
      color: orange;
      text-transform: uppercase;
    }

    /*------------------------*/

    @media (min-width: 700px) and (max-width: 1000px) {
      h4 {
        font-size: 2rem;
      }

      #cartTable th,
      #cartTable td {
        font-size: 2rem;
      }

      button {
        font-size: 2rem;
        margin: 1rem;
      }

      .empty {
        font-size: 2rem;
      }
    }

    @media (min-width: 200px) and (max-width: 600px) {
      .empty {
        font-size: 2.5rem;
      }
    }
  </style>
  <body>
    <h4>CART</h4>

    <table
      border="1"
      id="cartTable"
      style="width: 100%; text-align: left; border-collapse: collapse"
    >
      <thead>
        <tr>
          <th>Product</th>

          <th>Qty</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody id="cartitem"></tbody>
    </table>

    <button class="checkout" type="button">Proceed to checkout</button>

    <p id="thankyoumessage"></p>

    <button
      class="continue"
      type="button"
      onclick="window.location.href='index.html'"
    >
      Continue Shopping
    </button>

    <script>
      //DOMContentLoaded

      //this means exeute after the html is completed
      //this is useful when we have our script src in head //otherwise no need
      //its similar to keyword defer ,but the difference is
      //defer will work only for external js ..but this will
      //work in all cases ..internal(inside the script which is in same html page)
      document.addEventListener("DOMContentLoaded", function () {
        const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
        const username = user.username;

        const allCarts = JSON.parse(localStorage.getItem("allCarts")) || {};

        const spices = allCarts[username] || [];

        const addproducts = document.getElementById("cartitem");

        if (spices.length === 0) {
          const row = document.createElement("tr");
          const data = document.createElement("td");
          data.colSpan = 3;
          data.className = "empty";
          data.textContent = "Your Cart Is Empty.";
          row.appendChild(data);
          addproducts.appendChild(row);
        } else {
          const grouped = {};
          spices.forEach((item) => {
            if (grouped[item.name]) {
              grouped[item.name].qty += 1;
            } else {
              grouped[item.name] = { qty: 1, price: item.price };
            }
          });

          let grandtotal = 0;
          for (let name in grouped) {
            const row = document.createElement("tr");
            const nameCell = document.createElement("td");
            nameCell.className = "item-name"; //add calss to the <td>
            //since we want to add + and minus button we need this
            // nameCell.textContent = name;//replaces the text..means overwrite
            const nameText = document.createTextNode(name);
            nameCell.appendChild(nameText);
            //Create and append buttons
            const plusBtn = document.createElement("button");
            plusBtn.textContent = "+";
            plusBtn.className = "plus-btn"; //add class for styling
            plusBtn.onclick = () => updateCart(username, name, "add");

            const minusBtn = document.createElement("button");
            minusBtn.textContent = "-";
            minusBtn.className = "minus-btn";
            minusBtn.onclick = () => updateCart(username, name, "remove");
            // Optional: style or space the buttons
            plusBtn.style.marginLeft = "10px";
            minusBtn.style.marginLeft = "5px";
            // Add buttons to the name cell
            nameCell.appendChild(plusBtn);
            nameCell.appendChild(minusBtn);

            const qty = grouped[name].qty;
            const rawPrice = grouped[name].price;
            //etract numeric value using regex
            const priceMatch = rawPrice.match(/Rs\s*(\d+)\s*\//i); // rawPrice.match(/(\d+)\s*rs/i);
            const priceValue = priceMatch ? parseFloat(priceMatch[1]) : 0;
            //calculate subtotal
            const subtotal = qty * priceValue;
            grandtotal += subtotal;
            console.log(grandtotal);

            const priceCell = document.createElement("td");
            priceCell.className = "price";
            priceCell.textContent = `${rawPrice}*${qty} = Rs ${subtotal}`; //grouped[name].price;

            const qtyCell = document.createElement("td");
            qtyCell.textContent = grouped[name].qty;
            qtyCell.className = "quantity";

            /*const grandvalue = document.createElement("td");
            grandvalue.className = "grand";
            grandvalue.textContent = `GrandTotal=${grandtotal}`;*/

            //to reorder the th value..change appendchile(qty and price) so that it will change
            row.appendChild(nameCell);
            row.appendChild(qtyCell);
            row.appendChild(priceCell);
            //row.appendChild(grandvalue);
            addproducts.appendChild(row);

            function updateCart(username, itemName, action) {
              const allCarts =
                JSON.parse(localStorage.getItem("allCarts")) || {};
              const cart = allCarts[username] || [];
              if (action === "add") {
                //find existing item to get its price
                const existing = cart.find((i) => i.name === itemName);
                if (existing) {
                  cart.push({ name: itemName, price: existing.price });
                }
              } else if (action === "remove") {
                //Remove the first occurence of the item
                const index = cart.findIndex((i) => i.name === itemName);

                if (index !== -1) {
                  cart.splice(index, 1);
                }
              }

              // Save back to localStorage
              allCarts[username] = cart;
              localStorage.setItem("allCarts", JSON.stringify(allCarts));

              // Refresh the page to show updated cart
              location.reload();
            }
          }

          //createelement --small c caps e
          const TotalRow = document.createElement("tr");
          const labeldata = document.createElement("td");
          labeldata.colSpan = 3;
          labeldata.style.textAlign = "right";
          labeldata.style.fontWeight = "bold";
          labeldata.textContent = "GrandTotal:";

          const value = document.createElement("td");
          value.style.fontWeight = "bold";
          value.textContent = `â‚¹${grandtotal}`;

          TotalRow.appendChild(labeldata);
          TotalRow.appendChild(value);
          addproducts.appendChild(TotalRow);

          const checkoutbutton = document.querySelector(".checkout");
          checkoutbutton.addEventListener("click", () => {
            alert("Proceeding to checkout...");
            const message = document.getElementById("thankyoumessage");
            message.textContent = "Thanks for your order!";
            message.style.display = "block";
            setTimeout(() => {
              window.location.href = "index.html";
            }, 1500);
          });
        }
      });
    </script>
  </body>
</html>
